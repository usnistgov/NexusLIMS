
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Session logging (deprecated) &#8212; NexusLIMS 1.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom-styles.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/custom.js"></script>
    <link rel="shortcut icon" href="_static/nexusLIMS_bare_logo.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API documentation" href="api.html" />
    <link rel="prev" title="Tips for customizing CDCS" href="customizing_cdcs.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><span><img src="_static/logo_horizontal.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="api.html">API Docs</a></li>
                <li><a href="https://github.com/usnistgov/NexusLIMS">Repository</a></li>
                <li><a href="https://www.nist.gov/mml/odi">NIST ODI</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site Map <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api/nexusLIMS.html">nexusLIMS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api/nexusLIMS.builder.html">nexusLIMS.builder package</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/nexusLIMS.db.html">nexusLIMS.db package</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/nexusLIMS.extractors.html">nexusLIMS.extractors package</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/nexusLIMS.harvesters.html">nexusLIMS.harvesters package</a></li>
<li class="toctree-l3"><a class="reference internal" href="api/nexusLIMS.schemas.html">nexusLIMS.schemas package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="customizing_cdcs.html" title="Previous Chapter: Tips for customizing CDCS"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Previous</span>
    </a>
  </li>
  <li>
    <a href="api.html" title="Next Chapter: API documentation"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Next &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><img src="_static/nexusLIMS_bare_logo.png">
<h4><a href="index.html" title="Return to documentation home">
    NexusLIMS Documentation</a></h4>
<ul class="globaltoc">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API documentation</a></li>
</ul>

</ul><h4>
    <a class="no-hover">Page content</a>
</h4>

<ul>
<li><a class="reference internal" href="#">Session logging (deprecated)</a><ul>
<li><a class="reference internal" href="#how-to-use-the-logger-app">How to use the logger app</a></li>
<li><a class="reference internal" href="#actions-performed-by-the-logger">Actions performed by the logger</a></li>
<li><a class="reference internal" href="#information-collected">Information collected</a></li>
<li><a class="reference internal" href="#logger-implementation-and-deployment">Logger implementation and deployment</a></li>
</ul>
</li>
</ul>

<form action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<div id="sourcelink">
  <a href="_sources/session_logger_app.rst.txt"
     rel="nofollow">View page source</a>
</div>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="session-logging-deprecated">
<h1>Session logging (deprecated)<a class="headerlink" href="#session-logging-deprecated" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p><cite>Last updated: June 13, 2022</cite></p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please note that the Session Logger application has been deprecated as of
late 2021 in favor of using the NEMO laboratory management system to determine
when experimental sessions have taken place (using the py:mod:<cite>~nexusLIMS.harvesters.nemo</cite>
module). Maintaining the Session Logger application deployed across dozens of microscopes
was not scalable, hence the change in approach. This documentation page is left as a
record of prior development.</p>
<p>If you are deploying NexusLIMS at your institution and are interested in the session logger
application, please contact the NexusLIMS authors, as the code is available upon request.
The following documentation describes the operation of the Session Logger application
as of mid-2020.</p>
</div>
<p>To accurately know what files should be included in each Experiment’s record,
it is important to have a timestamp for the beginning <cite>and</cite> end of when a user
has collected data. To facilitate collecting this information, a small
application has been written that is run from the microscope support (or
control) PC and logs basic session information to the
<a class="reference internal" href="database.html"><span class="doc">NexusLIMS database</span></a>. This document explains how this
application is used, its design, what information it collects, and how it is
deployed to the individual microscopes.</p>
<section id="how-to-use-the-logger-app">
<h2>How to use the logger app<a class="headerlink" href="#how-to-use-the-logger-app" title="Permalink to this headline">¶</a></h2>
<p>Using the Session Logger application is very simple. On each
microscope, there will be a shortcut on the desktop that points to the
application that has been stored within a local directory on the computer. At
the beginning of an Experiment, double click on the following icon to start a
session:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/logger_icon.png"><img alt="Session Logger application shortcut icon" src="_images/logger_icon.png" style="width: 15%;" /></a>
</figure>
<p>After a short delay (about 5 seconds, depending on the microscope), the
application will launch and perform a number of steps (described
<a class="reference internal" href="#actions">below</a>), resulting in a display informing the user that a session
has been started:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/logger_in_action.png"><img alt="Session Logger application in action" src="_images/logger_in_action.png" style="width: 30%;" /></a>
</figure>
<p>Once this screen is displayed, the user should simply keep the window open
while they work (it can be minimized with no problem). The logger does not
perform any actions during this stage, and is simply waiting for the user to
click the <cite>“End Session”</cite> button.</p>
<p>Once the user has finished collecting data, they should click the large
<cite>“End Session”</cite> button in the application. This will trigger the application
to mark the current Experiment as finished in the <a class="reference internal" href="database.html"><span class="doc">database</span></a>,
and the logger application will close itself after a short delay.</p>
<section id="what-if-something-goes-wrong">
<h3>What if something goes wrong?<a class="headerlink" href="#what-if-something-goes-wrong" title="Permalink to this headline">¶</a></h3>
<p>In the unlikely event that the logger application encounters an unexpected
condition in the database or other error, it will inform the user and pop-up
a debugging log with more information (this log can also always be accessed
by clicking the <cite>“Show debug log”</cite> button on the main screen):</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/logger_log.png"><img alt="Session Logger debugging log window" src="_images/logger_log.png" style="width: 40%;" /></a>
</figure>
<p>If this log window appears on its own (which it shouldn’t), we ask that that
you click the <cite>“Copy”</cite> button to copy all the text to the clipboard and send it
to the facility managers so they can attempt to resolve the issue.</p>
</section>
<section id="interrupted-sessions">
<span id="interrupted"></span><h3>Interrupted sessions<a class="headerlink" href="#interrupted-sessions" title="Permalink to this headline">¶</a></h3>
<p>The session logger application does it’s best to ensure that if the window is
closed by any means, it sends an <cite>“End Session”</cite> log to the
<a class="reference internal" href="database.html"><span class="doc">database</span></a>. There is an option to “Pause Session” however,
which is prompted if the regular “Close window” button is clicked:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/logger_pause_session.png"><img alt="Session Logger pause session option" src="_images/logger_pause_session.png" style="width: 50%;" /></a>
</figure>
<p>Clicking <cite>“Pause session”</cite> will immediately close the application without
sending any further information to the database, and should only be done if the
user plans to resume the session before another user will use the instrument
(e.g. they need to restart the computer for some reason). Pausing the session
will leave the database in an inconsistent state, which will be detected the
next time the logger application is run. If this is the case, the user will be
prompted to confirm whether they want to continue the existing session, or
start a new one:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/logger_resume_session.png"><img alt="Session Logger pause session option" src="_images/logger_resume_session.png" style="width: 40%;" /></a>
</figure>
<p>This dialog will also appear when the user clicks on the desktop shortcut
in the event the computer crashed for some reason and the application was
forcibly closed. Clicking <cite>“Continue”</cite> will cause the application to use the
existing session (found in the database), while clicking <cite>“New session”</cite> will
end the session that was found and start a new one.</p>
</section>
</section>
<section id="actions-performed-by-the-logger">
<span id="actions"></span><h2>Actions performed by the logger<a class="headerlink" href="#actions-performed-by-the-logger" title="Permalink to this headline">¶</a></h2>
<p>The NexusLIMS Session Logger performs a number of steps to record that an
Experiment has occurred, and keeps the progress bar up to date while it is
operating. These steps are detailed below.</p>
<section id="mounting-the-network-share">
<span id="step-1"></span><h3>1. Mounting the network share<a class="headerlink" href="#mounting-the-network-share" title="Permalink to this headline">¶</a></h3>
<p>The first action performed by the logger is to “ping” the central file server
where data is saved and the NexusLIMS database is stored. Based on the
response, the logger stores the IP address of this server (to avoid problems
with the DNS server). The logger then looks at the currently mounted drives on
the microscope computer and picks a drive letter that is not in use. With this
information, the program runs a Windows command to mount the drive, such as:</p>
<div class="highlight-bat notranslate"><div class="highlight"><pre><span></span>net use H: \\network-path\to\directory\holding-NexusLIMS-DB
</pre></div>
</div>
<p>After this command finishes, the logger confirms that it can access the
database file as expected, and raises an error if not.</p>
</section>
<section id="getting-the-instrument-name">
<h3>2. Getting the instrument name<a class="headerlink" href="#getting-the-instrument-name" title="Permalink to this headline">¶</a></h3>
<p>Using the database file on the mounted drive, the logger application queries
the <code class="docutils literal notranslate"><span class="pre">instruments</span></code> table in the database using the <cite>“hostname”</cite> of the current
computer. In this way, a computer name (such as <code class="docutils literal notranslate"><span class="pre">TITAN52331880</span></code>) gets mapped
to an instrument persistent identifier (PID) (such as <code class="docutils literal notranslate"><span class="pre">FEI-Titan-TEM-635816</span></code>)
and this value is stored for later use.</p>
</section>
<section id="checking-instrument-status">
<h3>3. Checking instrument status<a class="headerlink" href="#checking-instrument-status" title="Permalink to this headline">¶</a></h3>
<p>Before logging the start of a new Experiment, first the logger application
checks to ensure that the most recent entry logged for this instrument was
an <code class="docutils literal notranslate"><span class="pre">'END'</span></code> entry, meaning that the last session was marked as finished.
For example, the code runs a query such as the following to get the most
recent entry (that was not a record generation event):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="n">session_identifier</span><span class="p">,</span><span class="w"> </span><span class="n">id_session_log</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">session_log</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">instrument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;FEI-Titan-TEM-635816&#39;</span><span class="w"></span>
<span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">event_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RECORD_GENERATION&#39;</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>If this most recent entry is an <code class="docutils literal notranslate"><span class="pre">'END'</span></code>, the database is in its expected
normal state, and the application continues on as normal. If it is instead a
<code class="docutils literal notranslate"><span class="pre">'START'</span></code> entry, then the application asks the user
whether they want to continue the existing session found in the database, or
start a new one (see the <a class="reference internal" href="#interrupted">interrupted session</a> section for more
details). If the user chooses to continue the existing session, the logger
application notes the session identifier from the database for that session and
jumps to <a class="reference internal" href="#step-6">step 6</a>.</p>
</section>
<section id="inserting-a-start-log">
<span id="step-4"></span><h3>4. Inserting a <code class="docutils literal notranslate"><span class="pre">START</span></code> log<a class="headerlink" href="#inserting-a-start-log" title="Permalink to this headline">¶</a></h3>
<p>With the instrument PID known and a randomly generated identifier string, the
logger runs a database insertion query on the <code class="docutils literal notranslate"><span class="pre">session_log</span></code> table to record
that a session has been started. While not explicitly specified in the query,
the current timestamp is also included in the insertion. As an example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">session_log</span><span class="w"> </span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">session_identifier</span><span class="p">,</span><span class="w"> </span><span class="k">user</span><span class="p">)</span><span class="w"></span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;FEI-Titan-TEM-635816&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;START&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">&#39;c9b774c9-4a59-4154-af05-0e2477e57cc4&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;local_user&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>After this has finished, the logger runs another query to verify that the row
was inserted into the database as expected, and raises an error if not.</p>
</section>
<section id="unmounting-the-network-share">
<h3>5. Unmounting the network share<a class="headerlink" href="#unmounting-the-network-share" title="Permalink to this headline">¶</a></h3>
<p>After the session start log has been added, the network share created in step 1
is unmounted to clean up while the logger application waits for the next
action. While the application is waiting, it simply sits idle until the
<cite>“End session”</cite> button is pressed.</p>
</section>
<section id="ending-the-session">
<span id="step-6"></span><h3>6. Ending the session<a class="headerlink" href="#ending-the-session" title="Permalink to this headline">¶</a></h3>
<p>Once the user clicks the <cite>“End session”</cite> button, the logger application again
mounts the network share (as in <a class="reference internal" href="#step-1">step 1</a>) so it can communicate with
the <a class="reference internal" href="database.html"><span class="doc">NexusLIMS database</span></a>. Using the same <cite>session identifier</cite>
value as before, the application inserts a corresponding <code class="docutils literal notranslate"><span class="pre">'END'</span></code> log into the
database using a query very similar to that in <a class="reference internal" href="#step-4">step 4</a>.
After verifying that this record was inserted correctly, the application
then updates the status of both the <code class="docutils literal notranslate"><span class="pre">'START'</span></code> and <code class="docutils literal notranslate"><span class="pre">'END'</span></code> logs for this
session from <code class="docutils literal notranslate"><span class="pre">'WAITING_FOR_END'</span></code> to <code class="docutils literal notranslate"><span class="pre">'TO_BE_BUILT'</span></code>. This status indicates
to the <a class="reference internal" href="record_building.html"><span class="doc">record builder</span></a> that it should go ahead to
actually build and upload the record for this Experiment.</p>
</section>
<section id="cleaning-up">
<h3>7. Cleaning up<a class="headerlink" href="#cleaning-up" title="Permalink to this headline">¶</a></h3>
<p>After updating the logs in the previous step, the logger application unmounts
the network share (as before), and if everything went according to plan,
waits three seconds and then shuts itself down. At this point, it is ready
to be run again by the next user that arrives to begin a new session.</p>
</section>
</section>
<section id="information-collected">
<h2>Information collected<a class="headerlink" href="#information-collected" title="Permalink to this headline">¶</a></h2>
<p>As described above and in the database <a class="reference internal" href="database.html"><span class="doc">documentation</span></a>, the
logger application collects the bare minimum amount of information required
to compile an Experiment’s record. The values collected from the microscope
computer that are recorded to the database with each log are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">session_identifier</span></code></p></td>
<td><p>A random UUID4 (36-character string) that
is consistent among the record’s
record’s <code class="docutils literal notranslate"><span class="pre">&quot;START&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;END&quot;</span></code>, and
<code class="docutils literal notranslate"><span class="pre">&quot;RECORD_GENERATION&quot;</span></code> events.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">instrument</span></code></p></td>
<td><p>The instrument PID associated with
this microscope’s computer</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></p></td>
<td><p>The current date and time (in local time)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">event_type</span></code></p></td>
<td><p>The type of log for this session (either
<code class="docutils literal notranslate"><span class="pre">&quot;START&quot;</span></code> for the beginning of an Experiment,
or <code class="docutils literal notranslate"><span class="pre">&quot;END&quot;</span></code> for the end of one).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">record_status</span></code></p></td>
<td><p>The status of the record
associated with this session.
Its value is <code class="docutils literal notranslate"><span class="pre">&quot;WAITING_FOR_END&quot;</span></code> at first, but
is updated to <code class="docutils literal notranslate"><span class="pre">&quot;TO_BE_BUILT&quot;</span></code> after the
session has ended.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">user</span></code></p></td>
<td><p>The username of the currently logged in user
(often this is just <code class="docutils literal notranslate"><span class="pre">supervisor</span></code> or <code class="docutils literal notranslate"><span class="pre">admin</span></code>)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="logger-implementation-and-deployment">
<h2>Logger implementation and deployment<a class="headerlink" href="#logger-implementation-and-deployment" title="Permalink to this headline">¶</a></h2>
<p>As data security is of the utmost importance in
NexusLIMS, the developers felt it prudent to describe in detail the specific
implementation that was used to produce the session logger application that
runs on the microscope PCs (since these machines control critical
instrumentation).</p>
<p>The logger application is implemented in two files: <code class="docutils literal notranslate"><span class="pre">db_logger_gui.py</span></code> (that
contains the interactive GUI parts of the code) and <code class="docutils literal notranslate"><span class="pre">make_db_entry.py</span></code> (that
contains the database communication and logic code).</p>
<p>The application is written using 32-bit Python 3.4.4 (in order to support
computers back to Windows XP) and is compiled to a single .exe file using the
<a class="reference external" href="https://www.pyinstaller.org/"><code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code></a> package for simple deployment. The executable is built by using
the <code class="docutils literal notranslate"><span class="pre">db_logger_gui.spec</span></code> file and running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pyinstaller.exe db_logger_gui.spec
</pre></div>
</div>
<p>The logger application is compiled to <code class="docutils literal notranslate"><span class="pre">NexusLIMS</span> <span class="pre">Session</span> <span class="pre">Logger.exe</span></code>, and this
file is then copied to the centralized file storage at
<code class="docutils literal notranslate"><span class="pre">//network/path/to/mmfnexus/folder/NexusLIMS/NexusLIMS</span> <span class="pre">Session</span> <span class="pre">Logger.exe</span></code>,
where it is then pulled down to the individual microscope PCs by the startup
batch script that is used to mount the centralized file storage. Each Nexus
microscope has a desktop shortcut that points to this copied file, so users are
able to launch the latest version of the logger application each time they
click the icon.</p>
<p>The application runs as a
<a class="reference external" href="https://en.wikipedia.org/wiki/Portable_Executable">portable executable</a>,
meaning it does not get “installed” onto the computer running it in the
traditional sense, and leaves nothing behind in the Windows registry or on the
filesystem. It also runs without administrator privileges. The app extracts a
minimal Python runtime to a temporary folder, which is removed when the
application is closed (on Windows XP machines, this is usually in the
<code class="docutils literal notranslate"><span class="pre">C:\Documents</span> <span class="pre">and</span> <span class="pre">Settings\&lt;username&gt;\Local</span> <span class="pre">Settings\Temp\_MEI#####</span></code>
folder, where <code class="docutils literal notranslate"><span class="pre">#####</span></code> is a random number). This step is the reason for
the small delay when first starting the logger.</p>
<p>The session logging app is written mostly using “pure” Python (meaning
it primarily utilizes built-in modules). The GUI portions are written using
the <a class="reference external" href="https://wiki.python.org/moin/TkInter">TkInter</a> library, while the
database communication uses the
<a class="reference external" href="https://docs.python.org/3/library/sqlite3.html">sqlite3</a> library. A few
<cite>Windows</cite>-specific parts of the code are used to find an unused drive letter
to mount the central file network share using the
<a class="reference external" href="https://docs.python.org/3.4/library/ctypes.html">ctypes</a> module.</p>
<section id="system-calls">
<h3>System calls<a class="headerlink" href="#system-calls" title="Permalink to this headline">¶</a></h3>
<p>While most of the logger application’s logic is implemented in the Python code,
a few operations require interfacing directly with the microscope computer
via <cite>Windows</cite> command line operations.
These commands are run using the
<a class="reference external" href="https://docs.python.org/3.4/library/subprocess.html">subprocess</a> module, and
are explained here so Nexus microscope operators have a reference for every
command that is run on their machines:</p>
<ul>
<li><p>The first two system calls are used by the GUI code (<code class="docutils literal notranslate"><span class="pre">db_logger_gui.py</span></code>)
and query the local system to get the current
monitor resolution and display DPI, so the logger application can be reliably
placed in the center of the screen:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wmic</span> <span class="n">path</span> <span class="n">Win32_VideoController</span> <span class="n">get</span> <span class="n">CurrentHorizontalResolution</span><span class="p">,</span> <span class="n">CurrentVerticalResolution</span>
</pre></div>
</div>
<p>This command uses the
<a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic">Windows Management Instrumentation command-line (WMIC) utility</a>
(in read-only mode) to get the current screen width and height in pixels.
The next command is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="n">query</span> <span class="s2">&quot;HKCU\Control Panel\Desktop\WindowMetrics&quot;</span> <span class="o">/</span><span class="n">v</span> <span class="n">AppliedDPI</span>
</pre></div>
</div>
<p>This command queries (again, read-only) the Windows registry to get the display
“scaling factor”, which affects how wide windows are by default. The output
of these last two commands is used to calculate the correct placement to
ensure the GUI window opens in the center of the screen.</p>
</li>
<li><p>The next system call is used by the database communication module
(<code class="docutils literal notranslate"><span class="pre">make_db_entry.py</span></code>) to get the IP address of the central file system where
the database file is stored (<code class="docutils literal notranslate"><span class="pre">//network.host.for.file.storage/</span></code>), since mounting via IP is
more reliable than using the host name. The command used for this is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ping</span> <span class="n">network</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="k">for</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">storage</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span>
</pre></div>
</div>
<p>This command will send a single ping to the server and resolve the host name
to an IP address. The output of the command is parsed to find the IP that
should be used to mount the network location.</p>
</li>
<li><p>Next, the <code class="docutils literal notranslate"><span class="pre">make_db_entry.py</span></code> module runs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="n">use</span>
</pre></div>
</div>
<p>to list the currently mounted network drives. If the required network location
(<code class="docutils literal notranslate"><span class="pre">//network.host.for.file.storage/nexusLIMS</span></code>) is already mounted, that drive
path is used rather than mounting another copy. If it is not, the path will
be mounted using a command:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="n">use</span> <span class="n">H</span><span class="p">:</span> \\<span class="n">network</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="k">for</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">storage</span>\<span class="n">nexusLIMS</span>
</pre></div>
</div>
<p>The drive letter (in this example <code class="docutils literal notranslate"><span class="pre">H:</span></code>) is automatically determined by
finding a currently unused drive letter earlier in the code.</p>
</li>
<li><p>Finally, when the database operations have finished, the code runs one final
system call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="n">use</span> <span class="n">H</span><span class="p">:</span> <span class="o">/</span><span class="k">del</span> <span class="o">/</span><span class="n">y</span>
</pre></div>
</div>
<p>which simply unmounts the network drive that was used earlier to connect to
the database.</p>
</li>
</ul>
</section>
<section id="application-dependencies">
<h3>Application dependencies<a class="headerlink" href="#application-dependencies" title="Permalink to this headline">¶</a></h3>
<p>The third-party dependencies used by the logger application are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 15%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Package</p></th>
<th class="head"><p>Version</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://psutil.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">psutil</span></code></a></p></td>
<td><p>3.4.2</p></td>
<td><p><strong>Primary dependency</strong></p>
<p>Used to ensure that only one copy of
the logger application can be run at one
time (when running as a compiled .exe)</p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://www.pyinstaller.org/"><code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code></a></p></td>
<td><p>3.5</p></td>
<td><p><strong>Primary dependency</strong></p>
<p>Used to compile the python modules
<code class="docutils literal notranslate"><span class="pre">make_db_entry.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">db_logger_gui.py</span></code> into a single .exe
file to be run on the microscope PCs</p>
</td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://pyperclip.readthedocs.io/en/latest/introduction.html"><code class="docutils literal notranslate"><span class="pre">pyperclip</span></code></a></p></td>
<td><p>1.7.0</p></td>
<td><p><strong>Primary dependency</strong></p>
<p>Used to access the system clipboard to
allow users to copy the debugging log to
a file in the case of error</p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/pycontribs/tendo"><code class="docutils literal notranslate"><span class="pre">tendo</span></code></a></p></td>
<td><p>0.2.15</p></td>
<td><p><strong>Primary dependency</strong></p>
<p>Used to ensure only one version of the
application can be run when running
directly as a Python module, rather than
as an .exe (<code class="docutils literal notranslate"><span class="pre">psutil</span></code> is used in that
case)</p>
</td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://altgraph.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">altgraph</span></code></a></p></td>
<td><p>0.16.1</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A graph library installed as a dependency
of <code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/erocarrera/pefile"><code class="docutils literal notranslate"><span class="pre">pefile</span></code></a></p></td>
<td><p>2019.4.18</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A library for creating portable
executable files, installed as a
dependency of <code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code></p>
</td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://pypi.org/project/future/"><code class="docutils literal notranslate"><span class="pre">future</span></code></a></p></td>
<td><p>0.18.2</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A Python 2/3 compatibility layer
installed as a dependency of <code class="docutils literal notranslate"><span class="pre">pefile</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/enthought/pywin32-ctypes"><code class="docutils literal notranslate"><span class="pre">pywin32-ctypes</span></code></a></p></td>
<td><p>0.2.0</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A re-implementation of <code class="docutils literal notranslate"><span class="pre">pywin32</span></code> in
pure Python, installed as a dependency of
<code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code></p>
</td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://setuptools.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">setuptools</span></code></a></p></td>
<td><p>18.2</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A Python project packaging library,
installed as a dependency of
<code class="docutils literal notranslate"><span class="pre">PyInstaller</span></code> and <code class="docutils literal notranslate"><span class="pre">tendo</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/openstack/pbr"><code class="docutils literal notranslate"><span class="pre">pbr</span></code></a></p></td>
<td><p>5.4.4</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>Another Python packaging library,
installed as a dependency of <code class="docutils literal notranslate"><span class="pre">tendo</span></code></p>
</td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://pip.pypa.io/en/stable/"><code class="docutils literal notranslate"><span class="pre">pip</span></code></a></p></td>
<td><p>7.1.2</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>The <cite>Python Package Installer</cite>, used to
install the other packages and as a
dependency of <code class="docutils literal notranslate"><span class="pre">tendo</span></code></p>
</td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://six.readthedocs.io/"><code class="docutils literal notranslate"><span class="pre">six</span></code></a></p></td>
<td><p>1.13.0</p></td>
<td><p><cite>Secondary dependency</cite></p>
<p>A Python 2/3 compatibility library
installed as a dependency of <code class="docutils literal notranslate"><span class="pre">tendo</span></code></p>
</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/session_logger_app.rst.txt"
     rel="nofollow">View page source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2022, NIST Office of Data and Informatics.<br/>
      Last updated on Jul, 15, 2022.<br/>
    </p>
  </div>
</footer>

  </body>
</html>