
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nexusLIMS.extractors.digital_micrograph &#8212; NexusLIMS 1.4.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom-styles.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/custom.js"></script>
    <link rel="shortcut icon" href="../../../_static/nexusLIMS_bare_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>
<script>
$(document).ready(function(){
  // Mark external (non-nist.gov) A tags with class "external"
  //If the adress start with https and ends with nist.gov
  var re_nist = new RegExp('^https?:\/\/((^\/)*\.)*nist\\.gov(\/|$)');
  var re_nist_github = new RegExp('^https:\/\/github.com\/usnistgov(\/|$)');
  //Regex to find address that start with https
  var re_absolute_address = new RegExp('^((https?:)?\/\/)');
  $("a").each(function(){
    var url=$(this).attr('href');
    if(re_nist.test(url) || !re_absolute_address.test(url) || re_nist_github.test(url)){
      $(this).addClass('leave_notice_local');
    }else{
      //This a href appears to be external, so tag it
      $(this).addClass('leave_notice_external');
    }
  });
  // Add leaveNotice to external A elements
  $('a.leave_notice_external').leaveNotice();
});
</script>
<link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo_horizontal.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../api.html">API Docs</a></li>
                <li><a href="https://github.com/usnistgov/NexusLIMS">Repository</a></li>
                <li><a href="https://www.nist.gov/mml/odi">NIST ODI</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site Map <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/nexusLIMS.html">nexusLIMS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.builder.html">nexusLIMS.builder package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.db.html">nexusLIMS.db package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.extractors.html">nexusLIMS.extractors package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.harvesters.html">nexusLIMS.harvesters package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/nexusLIMS.harvesters.nemo.html">nexusLIMS.harvesters.nemo package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.schemas.html">nexusLIMS.schemas package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Previous</span>
    </a>
  </li>
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Next &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><img src="../../../_static/nexusLIMS_bare_logo.png">
<h4><a href="../../../index.html" title="Return to documentation home">
    NexusLIMS Documentation</a></h4>
<ul class="globaltoc">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API documentation</a></li>
</ul>

</ul><h4>
    <a class="no-hover">Page content</a>
</h4>


<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for nexusLIMS.extractors.digital_micrograph</h1><div class="highlight"><pre>
<span></span><span class="c1">#  NIST Public License - 2023</span>
<span class="c1">#</span>
<span class="c1">#  See the LICENSE file in the root of this project</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;Parse and extract metadata from files saved by Gatan&#39;s DigitalMicrograph software.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">error</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">hyperspy.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DM3DataTypeError</span><span class="p">,</span>
    <span class="n">DM3FileVersionError</span><span class="p">,</span>
    <span class="n">DM3TagError</span><span class="p">,</span>
    <span class="n">DM3TagIDError</span><span class="p">,</span>
    <span class="n">DM3TagTypeError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">hyperspy.io</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">hs_load</span>

<span class="kn">from</span> <span class="nn">nexusLIMS.extractors.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_coerce_to_list</span><span class="p">,</span>
    <span class="n">_find_val</span><span class="p">,</span>
    <span class="n">_parse_filter_settings</span><span class="p">,</span>
    <span class="n">_set_acquisition_device_name</span><span class="p">,</span>
    <span class="n">_set_camera_binning</span><span class="p">,</span>
    <span class="n">_set_eds_meta</span><span class="p">,</span>
    <span class="n">_set_eels_meta</span><span class="p">,</span>
    <span class="n">_set_eels_processing</span><span class="p">,</span>
    <span class="n">_set_eels_spectrometer_meta</span><span class="p">,</span>
    <span class="n">_set_exposure_time</span><span class="p">,</span>
    <span class="n">_set_gms_version</span><span class="p">,</span>
    <span class="n">_set_image_processing</span><span class="p">,</span>
    <span class="n">_set_si_meta</span><span class="p">,</span>
    <span class="n">_try_decimal</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.instruments</span> <span class="kn">import</span> <span class="n">get_instr_from_filepath</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_nested_dict_key</span><span class="p">,</span>
    <span class="n">get_nested_dict_value_by_path</span><span class="p">,</span>
    <span class="n">remove_dict_nones</span><span class="p">,</span>
    <span class="n">remove_dtb_element</span><span class="p">,</span>
    <span class="n">set_nested_dict_value</span><span class="p">,</span>
    <span class="n">sort_dict</span><span class="p">,</span>
    <span class="n">try_getting_dict_value</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_dm3_metadata"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.get_dm3_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_dm3_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>  <span class="c1"># noqa: PLR0912</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get metadata from a dm3 or dm4 file.</span>

<span class="sd">    Returns the metadata from a .dm3 file saved by Digital Micrograph, with some</span>
<span class="sd">    non-relevant information stripped out, and instrument specific metadata parsed and</span>
<span class="sd">    added by one of the instrument-specific parsers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        path to a .dm3 file saved by Gatan&#39;s Digital Micrograph</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : dict or None</span>
<span class="sd">        The extracted metadata of interest. If None, the file could not be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We do lazy loading so we don&#39;t actually read the data from the disk to</span>
    <span class="c1"># save time and memory.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">hs_load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span>
        <span class="n">DM3DataTypeError</span><span class="p">,</span>
        <span class="n">DM3FileVersionError</span><span class="p">,</span>
        <span class="n">DM3TagError</span><span class="p">,</span>
        <span class="n">DM3TagIDError</span><span class="p">,</span>
        <span class="n">DM3TagTypeError</span><span class="p">,</span>
        <span class="n">error</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;File reader could not open </span><span class="si">%s</span><span class="s2">, received exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># s is a list, rather than a single signal</span>
        <span class="n">m_list</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">original_metadata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">original_metadata</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_list</span><span class="p">):</span>
        <span class="c1"># Important trees:</span>
        <span class="c1">#   DocumentObjectList</span>
        <span class="c1">#     Contains information about the display of the information, including bits</span>
        <span class="c1">#     about annotations that are included on top of the image data, the CLUT</span>
        <span class="c1">#     (color look-up table), data min/max.</span>
        <span class="c1">#</span>
        <span class="c1">#   ImageList</span>
        <span class="c1">#     Contains the actual image information</span>

        <span class="c1"># Remove the trees that are not of interest:</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;ApplicationBounds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LayoutType&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DocumentTags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HasWindowPosition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ImageSourceList&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Image_Behavior&quot;</span><span class="p">,</span>
            <span class="s2">&quot;InImageMode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MinVersionList&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NextDocumentObjectID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PageSetup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Page_Behavior&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SentinelList&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Thumbnails&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WindowPosition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;root&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">m_tree</span> <span class="o">=</span> <span class="n">remove_dtb_element</span><span class="p">(</span><span class="n">m_tree</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>

        <span class="c1"># Within the DocumentObjectList tree, we really only care about the</span>
        <span class="c1"># AnnotationGroupList for each TagGroup, so go into each TagGroup and</span>
        <span class="c1"># delete everything but that...</span>
        <span class="c1"># NB: the hyperspy DictionaryTreeBrowser __iter__ function returns each</span>
        <span class="c1">#   tree element as a tuple containing the tree name and the actual</span>
        <span class="c1">#   tree, so we loop through the tag names by taking the first part</span>
        <span class="c1">#   of the tuple:</span>
        <span class="k">for</span> <span class="n">tg_name</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">DocumentObjectList</span><span class="p">:</span>
            <span class="c1"># tg_name should be &#39;TagGroup0&#39;, &#39;TagGroup1&#39;, etc.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="c1"># we want to keep this, so remove from the list to loop through</span>
            <span class="k">if</span> <span class="s2">&quot;AnnotationGroupList&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;AnnotationGroupList&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">m_tree</span> <span class="o">=</span> <span class="n">remove_dtb_element</span><span class="p">(</span>  <span class="c1"># noqa: PLW2901</span>
                    <span class="n">m_tree</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;DocumentObjectList.</span><span class="si">{</span><span class="n">tg_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">tg_name</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">ImageList</span><span class="p">:</span>
            <span class="c1"># tg_name should be &#39;TagGroup0&#39;, &#39;TagGroup1&#39;, etc.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="c1"># We want to keep &#39;ImageTags&#39; and &#39;Name&#39;, so remove from list</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;ImageTags&quot;</span><span class="p">)</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="c1"># k should be in [&#39;ImageData&#39;, &#39;UniqueID&#39;]</span>
                <span class="n">m_tree</span> <span class="o">=</span> <span class="n">remove_dtb_element</span><span class="p">(</span>  <span class="c1"># noqa: PLW2901</span>
                    <span class="n">m_tree</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;ImageList.</span><span class="si">{</span><span class="n">tg_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">as_dictionary</span><span class="p">()</span>

        <span class="c1"># Get the instrument object associated with this file</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">get_instr_from_filepath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># get the modification time (as ISO format):</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">mtime_iso</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">mtime</span><span class="p">,</span>
            <span class="n">tz</span><span class="o">=</span><span class="n">instr</span><span class="o">.</span><span class="n">timezone</span> <span class="k">if</span> <span class="n">instr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="c1"># if we found the instrument, then store the name as string, else None</span>
        <span class="n">instr_name</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># set type to Image by default</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Image&quot;</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_Imaging&quot;</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Creation Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime_iso</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Dimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Instrument ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr_name</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_microscope_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_eels_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_eds_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_spectrum_image_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># if the instrument name is None, this check will be false, otherwise</span>
        <span class="c1"># look for the instrument in our list of instrument-specific parsers:</span>
        <span class="k">if</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="n">_instr_specific_parsers</span><span class="p">:</span>
            <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_instr_specific_parsers</span><span class="p">[</span><span class="n">instr_name</span><span class="p">](</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># we don&#39;t need to save the filename, it&#39;s just for internal processing</span>
        <span class="k">del</span> <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span>

        <span class="c1"># sort the nx_meta dictionary (recursively) for nicer display</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_dict</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">])</span>

    <span class="c1"># return the first dictionary, which should contain the most information:</span>
    <span class="k">return</span> <span class="n">remove_dict_nones</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="parse_643_titan"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_643_titan">[docs]</a><span class="k">def</span> <span class="nf">parse_643_titan</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 643 FEI Titan.</span>

<span class="sd">    (&#39;`FEI-Titan-STEM-630901 in 217/F109`&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The 643 Titan will likely have session info defined, but it may not be</span>
    <span class="c1"># accurate, so add it to the warning list</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;Operator&quot;</span><span class="p">,</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">]:</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">val</span><span class="p">])</span>

    <span class="c1"># the 643Titan sets the Imaging mode to &quot;EFTEM DIFFRACTION&quot; when an</span>
    <span class="c1"># actual diffraction pattern is taken</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;Imaging Mode&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Imaging Mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;EFTEM DIFFRACTION&quot;</span>
    <span class="p">):</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Diffraction&quot;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_EFTEM_Diffraction&quot;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_642_titan"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_642_titan">[docs]</a><span class="k">def</span> <span class="nf">parse_642_titan</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 642 FEI Titan.</span>

<span class="sd">    (&#39;`FEI-Titan-TEM-635816 in 223/B115`&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># DONE: complete 642 titan metadata parsing including Tecnai tag</span>
    <span class="n">path_to_tecnai</span> <span class="o">=</span> <span class="n">get_nested_dict_key</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="s2">&quot;Tecnai&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path_to_tecnai</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># For whatever reason, the expected Tecnai Tag is not present,</span>
        <span class="c1"># so return to prevent errors below</span>
        <span class="k">return</span> <span class="n">mdict</span>

    <span class="n">tecnai_value</span> <span class="o">=</span> <span class="n">get_nested_dict_value_by_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path_to_tecnai</span><span class="p">)</span>
    <span class="n">microscope_info</span> <span class="o">=</span> <span class="n">tecnai_value</span><span class="p">[</span><span class="s2">&quot;Microscope Info&quot;</span><span class="p">]</span>
    <span class="n">tecnai_value</span><span class="p">[</span><span class="s2">&quot;Microscope Info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_tecnai_microscope_info</span><span class="p">(</span><span class="n">microscope_info</span><span class="p">)</span>
    <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path_to_tecnai</span><span class="p">,</span> <span class="n">tecnai_value</span><span class="p">)</span>

    <span class="c1"># - Tecnai info:</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Gun_Name&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Extractor_Voltage&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Gun_Lens_No&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Emission_Current&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Spot&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Mode&#39;]</span>
    <span class="c1">#     _ C2, C3, Obj, Dif lens strength:</span>
    <span class="c1">#         - ImageTags.Tecnai.Microscope_Info[&#39;C2_Strength&#39;, &#39;C3_Strength&#39;,</span>
    <span class="c1">#                                            &#39;Obj_Strength&#39;, &#39;Dif_Strength&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Image_Shift_x&#39;/&#39;Image_Shift_y&#39;])</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Stage_Position_x&#39; (y/z/theta/phi)]</span>
    <span class="c1">#     _ C1/C2/Objective/SA aperture sizes:</span>
    <span class="c1">#         _ ImageTags.Tecnai.Microscope_Info[&#39;(C1/C2/Obj/SA)_Aperture&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Mode&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Dispersion&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Aperture&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Prism_Shift&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Drift_Tube&#39;]</span>
    <span class="c1">#     _ ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][</span>
    <span class="c1">#           &#39;Total_Energy_Loss&#39;]</span>

    <span class="n">term_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Gun_Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gun Name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Extractor_Voltage&quot;</span><span class="p">:</span> <span class="s2">&quot;Extractor Voltage (V)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Camera_Length&quot;</span><span class="p">:</span> <span class="s2">&quot;Camera Length (m)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Gun_Lens_No&quot;</span><span class="p">:</span> <span class="s2">&quot;Gun Lens #&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Emission_Current&quot;</span><span class="p">:</span> <span class="s2">&quot;Emission Current (μA)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Spot&quot;</span><span class="p">:</span> <span class="s2">&quot;Spot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mode&quot;</span><span class="p">:</span> <span class="s2">&quot;Tecnai Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Defocus&quot;</span><span class="p">:</span> <span class="s2">&quot;Defocus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C2_Strength&quot;</span><span class="p">:</span> <span class="s2">&quot;C2 Lens Strength (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C3_Strength&quot;</span><span class="p">:</span> <span class="s2">&quot;C3 Lens Strength (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Obj_Strength&quot;</span><span class="p">:</span> <span class="s2">&quot;Objective Lens Strength (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Dif_Strength&quot;</span><span class="p">:</span> <span class="s2">&quot;Diffraction Lens Strength (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Microscope_Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Tecnai Microscope Name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User&quot;</span><span class="p">:</span> <span class="s2">&quot;Tecnai User&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Image_Shift_x&quot;</span><span class="p">:</span> <span class="s2">&quot;Image Shift X (μm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Image_Shift_y&quot;</span><span class="p">:</span> <span class="s2">&quot;Image Shift Y (μm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Stage_Position_x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;X (μm)&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Stage_Position_y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Y (μm)&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Stage_Position_z&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Z (μm)&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Stage_Position_theta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;θ (°)&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Stage_Position_phi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;φ (°)&quot;</span><span class="p">],</span>
        <span class="s2">&quot;C1_Aperture&quot;</span><span class="p">:</span> <span class="s2">&quot;C1 Aperture (μm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C2_Aperture&quot;</span><span class="p">:</span> <span class="s2">&quot;C2 Aperture (μm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Obj_Aperture&quot;</span><span class="p">:</span> <span class="s2">&quot;Objective Aperture (μm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SA_Aperture&quot;</span><span class="p">:</span> <span class="s2">&quot;Selected Area Aperture (μm)&quot;</span><span class="p">,</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Mode&quot;</span><span class="p">):</span> <span class="p">[</span><span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Mode&quot;</span><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Dispersion&quot;</span><span class="p">):</span> <span class="p">[</span><span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Dispersion (eV/channel)&quot;</span><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Aperture&quot;</span><span class="p">):</span> <span class="p">[</span><span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Aperture (mm)&quot;</span><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Prism_Shift&quot;</span><span class="p">):</span> <span class="p">[</span><span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Prism Shift (eV)&quot;</span><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Drift_Tube&quot;</span><span class="p">):</span> <span class="p">[</span><span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;Drift Tube (eV)&quot;</span><span class="p">],</span>
        <span class="p">(</span><span class="s2">&quot;Filter_Settings&quot;</span><span class="p">,</span> <span class="s2">&quot;Total_Energy_Loss&quot;</span><span class="p">):</span> <span class="p">[</span>
            <span class="s2">&quot;Tecnai Filter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Total Energy Loss (eV)&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">in_term</span><span class="p">,</span> <span class="n">out_term</span> <span class="ow">in</span> <span class="n">term_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">path_to_tecnai</span><span class="p">),</span> <span class="s2">&quot;Microscope Info&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_term</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">in_term</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_term</span><span class="p">]</span>  <span class="c1"># noqa: PLW2901</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_term</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">in_term</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">in_term</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_term</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">out_term</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_term</span><span class="p">]</span>  <span class="c1"># noqa: PLW2901</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">in_term</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DO NOT EDIT&quot;</span><span class="p">,</span> <span class="s2">&quot;DO NOT ENTER&quot;</span><span class="p">]:</span>
            <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">out_term</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">path_to_tecnai</span><span class="p">),</span> <span class="s2">&quot;Specimen Info&quot;</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;not found&quot;</span><span class="p">,</span> <span class="s2">&quot;Specimen information is not available yet&quot;</span><span class="p">]:</span>
        <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># If `Tecnai Mode` is `STEM nP SA Zoom Diffraction`, it&#39;s diffraction</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;Tecnai Mode&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Tecnai Mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STEM nP SA Zoom Diffraction&quot;</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Detected file as Diffraction type based on &quot;Tecnai &#39;</span>
            <span class="s1">&#39;Mode&quot; == &quot;STEM nP SA Zoom Diffraction&quot;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Diffraction&quot;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STEM_Diffraction&quot;</span>

    <span class="c1"># also, if `Operation Mode` is `DIFFRACTION`, it&#39;s diffraction</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="s2">&quot;Operation Mode&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Operation Mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DIFFRACTION&quot;</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Detected file as Diffraction type based on &quot;Operation &#39;</span>
            <span class="s1">&#39;Mode&quot; == &quot;DIFFRACTION&quot;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Diffraction&quot;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_Diffraction&quot;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_642_jeol"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_642_jeol">[docs]</a><span class="k">def</span> <span class="nf">parse_642_jeol</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 642 FEI Titan.</span>

<span class="sd">    (&#39;`JEOL-JEM3010-TEM-565989 in 223/A132`&#39;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Currently, the Stroboscope does not add any metadata items that need to</span>
    <span class="c1"># be processed differently than the &quot;default&quot; dm3 tags (and it barely has</span>
    <span class="c1"># any metadata anyway), so this method does not need to do anything</span>

    <span class="c1"># To try to detect diffraction pattern, we will check the file name</span>
    <span class="c1"># against commonly used terms for saving diffraction patterns (not even</span>
    <span class="c1"># close to perfect, but at least it&#39;s something)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Diff&quot;</span><span class="p">,</span> <span class="s2">&quot;SAED&quot;</span><span class="p">,</span> <span class="s2">&quot;DP&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Detected file as Diffraction type based on &quot;</span><span class="si">%s</span><span class="s1">&quot; in the filename&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Diffraction&quot;</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_Diffraction&quot;</span>

    <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">])</span>
    <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;Data Type&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<span class="n">_instr_specific_parsers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;FEI-Titan-STEM-630901_n&quot;</span><span class="p">:</span> <span class="n">parse_643_titan</span><span class="p">,</span>
    <span class="s2">&quot;FEI-Titan-TEM-635816_n&quot;</span><span class="p">:</span> <span class="n">parse_642_titan</span><span class="p">,</span>
    <span class="s2">&quot;JEOL-JEM3010-TEM-565989_n&quot;</span><span class="p">:</span> <span class="n">parse_642_jeol</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="get_pre_path"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.get_pre_path">[docs]</a><span class="k">def</span> <span class="nf">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the appropriate pre-path in the metadata tag structure for a given signal.</span>

<span class="sd">    Get the path into a dictionary where the important DigitalMicrograph metadata is</span>
<span class="sd">    expected to be found. If the .dm3/.dm4 file contains a stack of images, the</span>
<span class="sd">    important metadata for NexusLIMS is not at its usual place and is instead under a</span>
<span class="sd">    `plan info` tag, so this method will determine if the stack metadata is present and</span>
<span class="sd">    return the correct path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A list containing the subsequent keys that need to be traversed to</span>
<span class="sd">    get to the point in the `mdict` where the important metadata is stored</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># test if we have a stack</span>
    <span class="n">stack_val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span>
        <span class="n">mdict</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;ImageList&quot;</span><span class="p">,</span> <span class="s2">&quot;TagGroup0&quot;</span><span class="p">,</span> <span class="s2">&quot;ImageTags&quot;</span><span class="p">,</span> <span class="s2">&quot;plane info&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">stack_val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
        <span class="c1"># we&#39;re in a stack</span>
        <span class="n">pre_path</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ImageList&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TagGroup0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ImageTags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plane info&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TagGroup0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source tags&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pre_path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ImageList&quot;</span><span class="p">,</span> <span class="s2">&quot;TagGroup0&quot;</span><span class="p">,</span> <span class="s2">&quot;ImageTags&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pre_path</span></div>


<div class="viewcode-block" id="parse_dm3_microscope_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_microscope_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_microscope_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the &quot;microscope info&quot; metadata.</span>

<span class="sd">    Parse the &quot;important&quot; metadata that is saved at specific places within the DM3 tag</span>
<span class="sd">    structure into a consistent place in the metadata dictionary returned by</span>
<span class="sd">    :py:meth:`get_dm3_metadata`. Specifically looks at the &quot;Microscope Info&quot;,</span>
<span class="sd">    &quot;Session Info&quot;, and &quot;Meta Data&quot; nodes (these are not present on every microscope).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The same metadata dictionary with some values added under the</span>
<span class="sd">        root-level ``nx_meta`` key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;nx_meta&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">:</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># pragma: no cover</span>

    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># General &quot;microscope info&quot; .dm3 tags (not present on all instruments):</span>
    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;Indicated Magnification&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Actual Magnification&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cs(mm)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;STEM Camera Length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Voltage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Operation Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Specimen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Microscope&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Operator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Imaging Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Illumination Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Field of View (</span><span class="se">\u00b5</span><span class="s2">m)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Facility&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage Alpha&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage Beta&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage X&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage Y&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Stage Position&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage Z&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;Microscope Info&quot;</span><span class="p">]</span>
        <span class="n">meta_key</span> <span class="o">=</span> <span class="n">_coerce_to_list</span><span class="p">(</span><span class="n">meta_key</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">meta_key</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not one of</span>
        <span class="c1"># the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DO NOT EDIT&quot;</span><span class="p">,</span> <span class="s2">&quot;DO NOT ENTER&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]</span>
        <span class="p">):</span>
            <span class="c1"># change output of &quot;Stage Position&quot; to unicode characters</span>
            <span class="k">if</span> <span class="s2">&quot;Stage Position&quot;</span> <span class="ow">in</span> <span class="n">meta_key</span><span class="p">:</span>
                <span class="n">meta_key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">meta_key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;α&quot;</span><span class="p">)</span>  <span class="c1"># noqa: RUF001</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Beta&quot;</span><span class="p">,</span> <span class="s2">&quot;β&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Stage &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">meta_key</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># General &quot;session info&quot; .dm3 tags (sometimes this information is stored</span>
    <span class="c1"># here instead of under &quot;Microscope Info&quot;:</span>
    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Detector&quot;</span><span class="p">,</span> <span class="s2">&quot;Microscope&quot;</span><span class="p">,</span> <span class="s2">&quot;Operator&quot;</span><span class="p">,</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;Session Info&quot;</span><span class="p">]</span>
        <span class="n">meta_key</span> <span class="o">=</span> <span class="n">_coerce_to_list</span><span class="p">(</span><span class="n">meta_key</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">meta_key</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DO NOT EDIT&quot;</span><span class="p">,</span> <span class="s2">&quot;DO NOT ENTER&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]</span>
        <span class="p">):</span>
            <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">meta_key</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># General &quot;Meta Data&quot; .dm3 tags</span>
    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;Acquisition Mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Signal&quot;</span><span class="p">,</span>
        <span class="c1"># this one is seen sometimes in EDS signals:</span>
        <span class="p">[</span><span class="s2">&quot;Experiment keywords&quot;</span><span class="p">,</span> <span class="s2">&quot;TagGroup1&quot;</span><span class="p">,</span> <span class="s2">&quot;Label&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;Meta Data&quot;</span><span class="p">]</span>
        <span class="n">meta_key</span> <span class="o">=</span> <span class="n">_coerce_to_list</span><span class="p">(</span><span class="n">meta_key</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">meta_key</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DO NOT EDIT&quot;</span><span class="p">,</span> <span class="s2">&quot;DO NOT ENTER&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;Label&quot;</span> <span class="ow">in</span> <span class="n">meta_key</span><span class="p">:</span>
                <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Analytic Label&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">set_nested_dict_value</span><span class="p">(</span>
                    <span class="n">mdict</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Analytic </span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">meta_key</span><span class="p">],</span>
                    <span class="n">val</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># acquisition device name:</span>
    <span class="n">_set_acquisition_device_name</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="c1"># exposure time:</span>
    <span class="n">_set_exposure_time</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="c1"># GMS version:</span>
    <span class="n">_set_gms_version</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="c1"># camera binning:</span>
    <span class="n">_set_camera_binning</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="c1"># image processing:</span>
    <span class="n">_set_image_processing</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;Illumination Mode&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="s2">&quot;STEM&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Illumination Mode&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STEM_Imaging&quot;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_dm3_eels_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_eels_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_eels_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse EELS information from the metadata.</span>

<span class="sd">    Parses metadata from the DigitalMicrograph tag structure that concerns any</span>
<span class="sd">    EELS acquisition or spectrometer settings, placing it in an ``EELS``</span>
<span class="sd">    dictionary underneath the root-level ``nx_meta`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dict with all the &quot;EELS-specific&quot; metadata added under ``nx_meta``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># EELS .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;EELS&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Exposure (s)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Integration time (s)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Number of frames&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Experimental Conditions&quot;</span><span class="p">,</span> <span class="s2">&quot;Collection semi-angle (mrad)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Experimental Conditions&quot;</span><span class="p">,</span> <span class="s2">&quot;Convergence semi-angle (mrad)&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
        <span class="n">_set_eels_meta</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">meta_key</span><span class="p">)</span>

    <span class="c1"># different instruments have the spectrometer information in different</span>
    <span class="c1"># places...</span>
    <span class="k">if</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Instrument ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FEI-Titan-TEM-635816_n&quot;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;EELS&quot;</span><span class="p">,</span> <span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Spectrometer&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Instrument ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FEI-Titan-STEM-630901_n&quot;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;EELS Spectrometer&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;Aperture label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Dispersion (eV/ch)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Energy loss (eV)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Instrument name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Drift tube enabled&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Drift tube voltage (V)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Slit inserted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Slit width (eV)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Prism offset (V)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Prism offset enabled &quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">meta_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta_key</span><span class="p">]</span>  <span class="c1"># noqa: PLW2901</span>
            <span class="n">_set_eels_spectrometer_meta</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">meta_key</span><span class="p">)</span>

    <span class="n">_set_eels_processing</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">)</span>

    <span class="c1"># Set the dataset type to Spectrum if any EELS tags were added</span>
    <span class="k">if</span> <span class="s2">&quot;EELS&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected file as Spectrum type based on presence of EELS metadata&quot;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Spectrum&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;STEM&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Illumination Mode&quot;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STEM_EELS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_EELS&quot;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_dm3_eds_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_eds_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_eds_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse EDS information from the dm3 metadata.</span>

<span class="sd">    Parses metadata from the DigitalMicrograph tag structure that concerns any</span>
<span class="sd">    EDS acquisition or spectrometer settings, placing it in an ``EDS``</span>
<span class="sd">    dictionary underneath the root-level ``nx_meta`` node. Metadata values</span>
<span class="sd">    that are commonly incorrect or may be placeholders are specified in a</span>
<span class="sd">    list under the ``nx_meta.warnings`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dictionary with all the &quot;EDS-specific&quot; metadata</span>
<span class="sd">        added as sub-node under the ``nx_meta`` root level dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># EELS .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;EDS&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Continuous Mode&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Count Rate Unit&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Dispersion (eV)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Energy Cutoff (V)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Exposure (s)&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Count rate&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Active layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Azimuthal angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Dead layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Detector type&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Elevation angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Fano&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Gold layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Incidence angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Solid angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage tilt&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Window thickness&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Window type&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Zero fwhm&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Live time&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Real time&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
        <span class="n">_set_eds_meta</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">meta_key</span><span class="p">)</span>

    <span class="c1"># test to see if the SI attribute is present in the metadata dictionary.</span>
    <span class="c1"># If so, then some relevant EDS values are located there, rather</span>
    <span class="c1"># than in the root-level EDS tag (all the EDS.Acquisition tags from</span>
    <span class="c1"># above)</span>
    <span class="k">if</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Continuous Mode&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Count Rate Unit&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Dispersion (eV)&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Energy Cutoff (V)&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Exposure (s)&quot;</span><span class="p">],</span>
        <span class="p">]:</span>
            <span class="n">_set_si_meta</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span><span class="p">,</span> <span class="n">meta_key</span><span class="p">)</span>

        <span class="c1"># for an SI EDS dataset, set &quot;Live time&quot;, &quot;Real time&quot; and &quot;Count rate&quot;</span>
        <span class="c1"># to the averages stored in the ImageList.TagGroup0.ImageTags.EDS.Images</span>
        <span class="c1"># values</span>
        <span class="n">im_dict</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;EDS&quot;</span><span class="p">,</span> <span class="s2">&quot;Images&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">im_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;EDS&quot;</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;EDS&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># this should work for 2D (spectrum image) as well as 1D</span>
                <span class="c1"># (linescan) datasets since DM saves this information as a 1D</span>
                <span class="c1"># list regardless of original data shape</span>
                <span class="n">avg_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">set_nested_dict_value</span><span class="p">(</span>
                    <span class="n">mdict</span><span class="p">,</span>
                    <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="s2">&quot;EDS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> (SI Average)&quot;</span><span class="p">],</span>
                    <span class="n">avg_val</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># Add the .dm3 EDS values to the warnings list, since they might not be</span>
    <span class="c1"># accurate</span>
    <span class="k">for</span> <span class="n">meta_key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;Count rate&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Active layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Azimuthal angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Dead layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Detector type&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Elevation angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Fano&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Gold layer&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Incidence angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Solid angle&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage tilt&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Window thickness&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Window type&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Detector Info&quot;</span><span class="p">,</span> <span class="s2">&quot;Zero fwhm&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Live time&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;Real time&quot;</span><span class="p">],</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">meta_key</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;warnings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;EDS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">meta_key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">meta_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="p">)</span>

    <span class="c1"># Set the dataset type to Spectrum if any EDS tags were added</span>
    <span class="k">if</span> <span class="s2">&quot;EDS&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detected file as Spectrum type based on presence of EDS metadata&quot;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Spectrum&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;STEM&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Illumination Mode&quot;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STEM_EDS&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no known files match this mode, so skip for coverage</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TEM_EDS&quot;</span>  <span class="c1"># pragma: no cover</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_dm3_spectrum_image_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_spectrum_image_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_spectrum_image_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse &quot;spectrum image&quot; information from the metadata.</span>

<span class="sd">    Parses metadata that concerns any spectrum imaging information (the &quot;SI&quot; tag) and</span>
<span class="sd">    places it in a &quot;Spectrum Imaging&quot; dictionary underneath the root-level ``nx_meta``</span>
<span class="sd">    node. Metadata values that are commonly incorrect or may be placeholders are</span>
<span class="sd">    specified in a list under the ``nx_meta.warnings`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dictionary with all the &quot;EDS-specific&quot; metadata</span>
<span class="sd">        added as sub-node under the ``nx_meta`` root level dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># Spectrum imaging .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pre_path</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">m_in</span><span class="p">,</span> <span class="n">m_out</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">([</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Pixel time (s)&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Pixel time (s)&quot;</span><span class="p">]),</span>
        <span class="p">([</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;SI Application Mode&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Scan Mode&quot;</span><span class="p">]),</span>
        <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Spatial Sampling&quot;</span><span class="p">,</span> <span class="s2">&quot;Height (pixels)&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Spatial Sampling (Vertical)&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Spatial Sampling&quot;</span><span class="p">,</span> <span class="s2">&quot;Width (pixels)&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Spatial Sampling (Horizontal)&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Scan Options&quot;</span><span class="p">,</span> <span class="s2">&quot;Sub-pixel sampling&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Sub-pixel Sampling Factor&quot;</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m_in</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
            <span class="c1"># add last value of each parameter to the &quot;EDS&quot; sub-tree of nx_meta</span>
            <span class="n">set_nested_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="s2">&quot;Spectrum Imaging&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">m_out</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Check spatial drift correction separately:</span>
    <span class="n">drift_per_val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span>
        <span class="n">mdict</span><span class="p">,</span>
        <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Artefact Correction&quot;</span><span class="p">,</span> <span class="s2">&quot;Spatial Drift&quot;</span><span class="p">,</span> <span class="s2">&quot;Periodicity&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">drift_unit_val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span>
        <span class="n">mdict</span><span class="p">,</span>
        <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Artefact Correction&quot;</span><span class="p">,</span> <span class="s2">&quot;Spatial Drift&quot;</span><span class="p">,</span> <span class="s2">&quot;Units&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">drift_per_val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">and</span> <span class="n">drift_unit_val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
        <span class="n">val_to_set</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Spatial drift correction every </span><span class="si">{</span><span class="n">drift_per_val</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">drift_unit_val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># make sure statement looks gramatically correct</span>
        <span class="k">if</span> <span class="n">drift_per_val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(s)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(s)&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="c1"># fix for &quot;seconds(s)&quot; (stupid DM...)</span>
        <span class="k">if</span> <span class="n">val_to_set</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ss&quot;</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">set_nested_dict_value</span><span class="p">(</span>
            <span class="n">mdict</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="s2">&quot;Spectrum Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;Artefact Correction&quot;</span><span class="p">],</span>
            <span class="n">val_to_set</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">start_val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;Start time&quot;</span><span class="p">])</span>
    <span class="n">end_val</span> <span class="o">=</span> <span class="n">try_getting_dict_value</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="s2">&quot;Acquisition&quot;</span><span class="p">,</span> <span class="s2">&quot;End time&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">start_val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">and</span> <span class="n">end_val</span> <span class="o">!=</span> <span class="s2">&quot;not found&quot;</span><span class="p">:</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s2">&quot;%I:%M:%S %p&quot;</span><span class="p">)</span>  <span class="c1"># noqa: DTZ007</span>
        <span class="n">end_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_val</span><span class="p">,</span> <span class="s2">&quot;%I:%M:%S %p&quot;</span><span class="p">)</span>  <span class="c1"># noqa: DTZ007</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_dt</span> <span class="o">-</span> <span class="n">start_dt</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>  <span class="c1"># Calculate acquisition duration</span>
        <span class="n">set_nested_dict_value</span><span class="p">(</span>
            <span class="n">mdict</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">,</span> <span class="s2">&quot;Spectrum Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;Acquisition Duration (s)&quot;</span><span class="p">],</span>
            <span class="n">duration</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Set the dataset type to SpectrumImage if it is already a Spectrum ( otherwise it&#39;s</span>
    <span class="c1"># just a STEM image) and any Spectrum Imaging tags were added</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;Spectrum Imaging&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Spectrum&quot;</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Detected file as SpectrumImage type based on &quot;</span>
            <span class="s2">&quot;presence of spectral metadata and spectrum imaging &quot;</span>
            <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;DatasetType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SpectrumImage&quot;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Spectrum_Imaging&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;EELS&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;EELS_Spectrum_Imaging&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;EDS&quot;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s2">&quot;nx_meta&quot;</span><span class="p">][</span><span class="s2">&quot;Data Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;EDS_Spectrum_Imaging&quot;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="process_tecnai_microscope_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.process_tecnai_microscope_info">[docs]</a><span class="k">def</span> <span class="nf">process_tecnai_microscope_info</span><span class="p">(</span>  <span class="c1"># noqa: PLR0915</span>
    <span class="n">microscope_info</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\u2028</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the Microscope_Info metadata string into a dictionary of key-value pairs.</span>

<span class="sd">    This method is only relevant for FEI Titan TEMs that write additional metadata into</span>
<span class="sd">    a unicode-delimited string at a certain place in the DM3 tag structure</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    microscope_info : str</span>
<span class="sd">        The string of data obtained from the Tecnai.Microscope_Info leaf of the metadata</span>
<span class="sd">    delimiter : str</span>
<span class="sd">        The value (a unicode string) used to split the ``microscope_info`` string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    info_dict : dict</span>
<span class="sd">        The information contained in the string, in a more easily-digestible form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tecnai_info</span> <span class="o">=</span> <span class="n">microscope_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Microscope_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Microscope &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>  <span class="c1"># String</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;User &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>  <span class="c1"># String</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Gun &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Gun_Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span> <span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot; Extr volt&quot;</span><span class="p">)]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Gun_Name&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Gun_Name&quot;</span><span class="p">])</span> <span class="p">:]</span>  <span class="c1"># String</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Extr volt &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Extractor_Voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Integer (volts)</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Gun Lens &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Gun Lens &quot;</span><span class="p">)</span> <span class="p">:]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Gun_Lens_No&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Integer</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Emission &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Emission &quot;</span><span class="p">)</span> <span class="p">:]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Emission_Current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;uA&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Decimal (microA)</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Mode &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span> <span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot; Defocus&quot;</span><span class="p">)]</span>  <span class="c1"># String</span>
    <span class="c1"># &#39;Mode&#39; should be five terms long, and the last term is either &#39;Image&#39;,</span>
    <span class="c1"># &#39;Diffraction&#39;, (or maybe something else)</span>

    <span class="c1"># Decimal val (micrometer)</span>
    <span class="k">if</span> <span class="s2">&quot;Magn &quot;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>  <span class="c1"># Imaging mode</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Defocus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Defocus (um) &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s2">&quot;CL &quot;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>  <span class="c1"># Diffraction mode</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Defocus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Defocus &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># This value changes based on whether in image or diffraction mode (mag or CL)</span>
    <span class="c1"># Integer</span>
    <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Image&quot;</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Magnification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Magn &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">))</span>
    <span class="c1"># Decimal</span>
    <span class="k">elif</span> <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Diffraction&quot;</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Camera_Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;CL &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">))</span>

    <span class="c1"># Integer (1 to 5)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Spot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Spot &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">))</span>

    <span class="c1"># Decimals - Lens strengths expressed as a &quot;%&quot; value</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;C2_Strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;C2 &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;C3_Strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;C3 &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Obj_Strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Obj &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Dif_Strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Dif &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">))</span>

    <span class="c1"># Decimal values (micrometers)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Image shift &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;um&quot;</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Image_Shift_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Image_Shift_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Decimal values are given in micrometers and degrees</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="s2">&quot;Stage &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_try_decimal</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; umdeg&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Stage_Position_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Stage_Position_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Stage_Position_z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Stage_Position_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Stage_Position_phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__read_aperture</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tecnai_info_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test if aperture has value or is retracted.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_find_val</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tecnai_info_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; um&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># Either an integer value or None (indicating the aperture was not</span>
    <span class="c1"># inserted or tag did not exist in the metadata)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;C1_Aperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s2">&quot;C1 Aperture: &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;C2_Aperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s2">&quot;C2 Aperture: &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;Obj_Aperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s2">&quot;OBJ Aperture: &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;SA_Aperture&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s2">&quot;SA Aperture: &quot;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>

    <span class="c1"># Nested dictionary</span>
    <span class="n">info_dict</span> <span class="o">=</span> <span class="n">_parse_filter_settings</span><span class="p">(</span><span class="n">info_dict</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">info_dict</span></div>
</pre></div>

    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2023, NIST Office of Data and Informatics.<br/>
      Last updated on Sep, 19, 2023.<br/>
    </p>
  </div>
</footer>

  </body>
</html>