
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nexusLIMS.harvesters.nemo.connector &#8212; NexusLIMS 1.4.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom-styles.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/custom.js"></script>
    <link rel="shortcut icon" href="../../../../_static/nexusLIMS_bare_logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>
<script>
$(document).ready(function(){
  // Mark external (non-nist.gov) A tags with class "external"
  //If the adress start with https and ends with nist.gov
  var re_nist = new RegExp('^https?:\/\/((^\/)*\.)*nist\\.gov(\/|$)');
  var re_nist_github = new RegExp('^https:\/\/github.com\/usnistgov(\/|$)');
  //Regex to find address that start with https
  var re_absolute_address = new RegExp('^((https?:)?\/\/)');
  $("a").each(function(){
    var url=$(this).attr('href');
    if(re_nist.test(url) || !re_absolute_address.test(url) || re_nist_github.test(url)){
      $(this).addClass('leave_notice_local');
    }else{
      //This a href appears to be external, so tag it
      $(this).addClass('leave_notice_external');
    }
  });
  // Add leaveNotice to external A elements
  $('a.leave_notice_external').leaveNotice();
});
</script>
<link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html"><span><img src="../../../../_static/logo_horizontal.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../api.html">API Docs</a></li>
                <li><a href="https://github.com/usnistgov/NexusLIMS">Repository</a></li>
                <li><a href="https://www.nist.gov/mml/odi">NIST ODI</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site Map <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/nexusLIMS.html">nexusLIMS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/nexusLIMS.builder.html">nexusLIMS.builder package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/nexusLIMS.db.html">nexusLIMS.db package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/nexusLIMS.extractors.html">nexusLIMS.extractors package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/nexusLIMS.harvesters.html">nexusLIMS.harvesters package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/nexusLIMS.harvesters.nemo.html">nexusLIMS.harvesters.nemo package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/nexusLIMS.schemas.html">nexusLIMS.schemas package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Previous</span>
    </a>
  </li>
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Next &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><img src="../../../../_static/nexusLIMS_bare_logo.png">
<h4><a href="../../../../index.html" title="Return to documentation home">
    NexusLIMS Documentation</a></h4>
<ul class="globaltoc">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API documentation</a></li>
</ul>

</ul><h4>
    <a class="no-hover">Page content</a>
</h4>


<form action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for nexusLIMS.harvesters.nemo.connector</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Defines the NemoConnector class that is used to interface with the NEMO API.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">parse_qs</span><span class="p">,</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlparse</span>

<span class="kn">from</span> <span class="nn">pytz</span> <span class="kn">import</span> <span class="n">timezone</span> <span class="k">as</span> <span class="n">pytz_timezone</span>

<span class="kn">from</span> <span class="nn">nexusLIMS.db.session_handler</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">SessionLog</span><span class="p">,</span> <span class="n">db_query</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.instruments</span> <span class="kn">import</span> <span class="n">get_instr_from_api_url</span><span class="p">,</span> <span class="n">instrument_db</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">nexus_req</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="NemoConnector"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector">[docs]</a><span class="k">class</span> <span class="nc">NemoConnector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A connection to an instance of the API of the NEMO laboratory management software.</span>

<span class="sd">    Provides helper methods for fetching data from the API.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_url : str</span>
<span class="sd">        The &quot;root&quot; of the API including a trailing slash;</span>
<span class="sd">        e.g. &#39;https://nemo.url.com/api/&#39;</span>
<span class="sd">    token : str</span>
<span class="sd">        An authentication token for this NEMO instance</span>
<span class="sd">    strftime_fmt : str</span>
<span class="sd">        The &quot;date format&quot; to use when encoding dates to send as filters to the</span>
<span class="sd">        NEMO API. Should follow the same convention as</span>
<span class="sd">        :ref:`strftime-strptime-behavior`. If ``None``, ISO 8601 format</span>
<span class="sd">        will be used.</span>
<span class="sd">    strptime_fmt : str</span>
<span class="sd">        The &quot;date format&quot; to use when decoding date strings received in the</span>
<span class="sd">        response from the API. Should follow the same convention as</span>
<span class="sd">        :ref:`strftime-strptime-behavior`. If ``None``, ISO 8601 format</span>
<span class="sd">        will be used.</span>
<span class="sd">    timezone : str</span>
<span class="sd">        The timezone to use when decoding date strings received in the</span>
<span class="sd">        response from the API. Should be a IANA time zone database string; e.g.</span>
<span class="sd">        &quot;America/New_York&quot;. Useful if no timezone information is returned</span>
<span class="sd">        from an instance of the NEMO API. If ``None``, no timezone setting will</span>
<span class="sd">        be done and the code will use whatever was returned from the server</span>
<span class="sd">        as is.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
    <span class="n">users</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
    <span class="n">users_by_username</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>
    <span class="n">projects</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments # noqa: PLR0913</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">strftime_fmt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strptime_fmt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timezone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="n">base_url</span><span class="p">,</span>
            <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
            <span class="s2">&quot;strftime_fmt&quot;</span><span class="p">:</span> <span class="n">strftime_fmt</span><span class="p">,</span>
            <span class="s2">&quot;strptime_fmt&quot;</span><span class="p">:</span> <span class="n">strptime_fmt</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># these attributes are used for &quot;memoization&quot; of NEMO content,</span>
        <span class="c1"># so it can be remembered and used for a cache lookup</span>
        <span class="c1"># keys should be NEMO internal IDs and values should be the</span>
        <span class="c1"># dictionary returned by the API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projects</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return custom representation of a NemoConnector.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Connection to NEMO API at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="NemoConnector.strftime"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.strftime">[docs]</a>    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_dt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert datetime to appropriate string format for this connector.</span>

<span class="sd">        Using the settings for this NemoConnector, convert a datetime object</span>
<span class="sd">        to a string that will be understood by the API. If the ``strftime_fmt``</span>
<span class="sd">        attribute for this NemoConnector is ``None``, ISO 8601 format will be</span>
<span class="sd">        used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date_dt</span>
<span class="sd">            The date to be converted as a datetime object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        date_str : str</span>
<span class="sd">            The date formatted as a string that will be understandable by the</span>
<span class="sd">            API for this NemoConnector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strftime_fmt&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">date_dt</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;%z&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strftime_fmt&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;%Z&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strftime_fmt&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">date_dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># make sure datetime is timezone aware if timezone is</span>
            <span class="c1"># indicated in strftime_fmt. Use NEMO_tz setting if present,</span>
            <span class="c1"># otherwise use local server timezone</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]:</span>
                <span class="n">date_dt</span> <span class="o">=</span> <span class="n">pytz_timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">date_dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">date_dt</span> <span class="o">=</span> <span class="n">date_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">date_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strftime_fmt&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="NemoConnector.strptime"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.strptime">[docs]</a>    <span class="k">def</span> <span class="nf">strptime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert string to datetime using this connector&#39;s API date format.</span>

<span class="sd">        Using the settings for this NemoConnector, convert a datetime string</span>
<span class="sd">        representation from the API into a datetime object that can be used</span>
<span class="sd">        in Python. If the ``strptime_fmt`` attribute for this NemoConnector</span>
<span class="sd">        is ``None``, ISO 8601 format will be assumed. If a timezone is</span>
<span class="sd">        specified for this server, the resulting datetime will be coerced to</span>
<span class="sd">        that timezone.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date_str</span>
<span class="sd">            The date formatted as a string that is returned by the</span>
<span class="sd">            API for this NemoConnector</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        date_dt : ~datetime.datetime</span>
<span class="sd">            The date to be converted as a datetime object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strptime_fmt&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># to be defensive here, try without microseconds as well if &quot;.%f&quot;</span>
            <span class="c1"># is in strptime_fmt and it fails (since sometimes NEMO doesn&#39;t</span>
            <span class="c1"># write microseconds for every time, even if it&#39;s supposed to</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>  <span class="c1"># noqa: DTZ007</span>
                    <span class="n">date_str</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strptime_fmt&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;.</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strptime_fmt&quot;</span><span class="p">]:</span>
                    <span class="n">date_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>  <span class="c1"># noqa: DTZ007</span>
                        <span class="n">date_str</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;strptime_fmt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">exception</span>  <span class="c1"># pragma: no cover</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]:</span>
            <span class="c1"># strip any timezone information from the datetime, then localize</span>
            <span class="c1"># with pytz to whatever timezone specified</span>
            <span class="n">date_dt</span> <span class="o">=</span> <span class="n">date_dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">date_dt</span> <span class="o">=</span> <span class="n">pytz_timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">date_dt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">date_dt</span></div>

<div class="viewcode-block" id="NemoConnector.get_tools"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_tools">[docs]</a>    <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of one or more tools from the NEMO API in a dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tool_id</span>
<span class="sd">            The tool(s) to fetch, as indexed by the NEMO instance (i.e.</span>
<span class="sd">            ``tool_id`` should be the internal primary key used by NEMO to</span>
<span class="sd">            identify the tool. If an empty list is given, all tools will be</span>
<span class="sd">            returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tools : List[Dict]</span>
<span class="sd">            A list (could be empty) of tools that match the id (or ids) given</span>
<span class="sd">            in ``tool_id``</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.HTTPError</span>
<span class="sd">            Raised if the request to the API did not go through correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">for</span> <span class="n">t_id</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Using cached tool info for tools </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">tool_id</span><span class="p">,</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">t_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">t_id</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id__in&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">])}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tool_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Using cached tool info for tool </span><span class="si">%s</span><span class="s1">: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="n">tool_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">tool_id</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_id</span><span class="p">}</span>

        <span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_caller</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;tools/&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
            <span class="c1"># cache the tool results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">tool</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tool</span>

        <span class="k">return</span> <span class="n">tools</span></div>

<div class="viewcode-block" id="NemoConnector.get_users"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_users">[docs]</a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of one or more users from the NEMO API in a dictionary.</span>

<span class="sd">        The results will be cached in the NemoConnector instance to prevent multiple</span>
<span class="sd">        API queries if not necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_id</span>
<span class="sd">            The user(s) to fetch, as indexed by the NEMO instance (i.e.</span>
<span class="sd">            ``user_id`` should be the internal primary key used by NEMO to</span>
<span class="sd">            identify the user. If an empty list or None is given, all users</span>
<span class="sd">            will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        users : List[Dict]</span>
<span class="sd">            A list (could be empty) of users that match the ids and/or</span>
<span class="sd">            usernames given</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.HTTPError</span>
<span class="sd">            Raised if the request to the API did not go through correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># list of user ids</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;id__in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">user_id</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">u_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="k">for</span> <span class="n">u_id</span> <span class="ow">in</span> <span class="n">user_id</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Using cached user info for users with id in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="p">,</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user_id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">u_id</span> <span class="ow">in</span> <span class="n">user_id</span><span class="p">]</span>
        <span class="c1"># single user id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_id</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Using cached user info for user id </span><span class="si">%s</span><span class="s1">: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user_id</span><span class="p">]]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_users_helper</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="NemoConnector.get_users_by_username"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_users_by_username">[docs]</a>    <span class="k">def</span> <span class="nf">get_users_by_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of one or more users from the NEMO API in a dictionary.</span>

<span class="sd">        The results will be cached in the NemoConnector</span>
<span class="sd">        instance to prevent multiple API queries if not necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        username : str or :obj:`list` of :obj:`str`</span>
<span class="sd">            The user(s) to fetch, as indexed by their usernames in the NEMO</span>
<span class="sd">            instance. If an empty list or None is given, all users</span>
<span class="sd">            will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        users : list</span>
<span class="sd">            A list (could be empty) of users that match the ids and/or</span>
<span class="sd">            usernames given</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.HTTPError</span>
<span class="sd">            Raised if the request to the API did not go through correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;username__iexact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using cached user info for username &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span><span class="p">[</span><span class="n">username</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;username__in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">uname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span> <span class="k">for</span> <span class="n">uname</span> <span class="ow">in</span> <span class="n">username</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using cached user info for users with id in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span><span class="p">[</span><span class="n">uname</span><span class="p">]</span> <span class="k">for</span> <span class="n">uname</span> <span class="ow">in</span> <span class="n">username</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_users_helper</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="NemoConnector.get_projects"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_projects">[docs]</a>    <span class="k">def</span> <span class="nf">get_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of one or more projects from the NEMO API in a dictionary.</span>

<span class="sd">        The local cache will be checked prior to fetching</span>
<span class="sd">        from the API to save a network request if possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        proj_id</span>
<span class="sd">            The project(s) to fetch, as indexed by the NEMO instance (i.e.</span>
<span class="sd">            ``proj_id`` should be the internal primary key used by NEMO to</span>
<span class="sd">            identify the project. If an empty list is given, all projects</span>
<span class="sd">            will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        projects : List[Dict]</span>
<span class="sd">            A list (could be empty) of projects that match the id (or ids) given</span>
<span class="sd">            in ``proj_id``</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        requests.exceptions.HTTPError</span>
<span class="sd">            Raised if the request to the API did not go through correctly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proj_id</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projects</span> <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="n">proj_id</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Using cached project info for projects </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">proj_id</span><span class="p">,</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">proj_id</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">p_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="n">proj_id</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id__in&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proj_id</span><span class="p">])}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">proj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Using cached project info for project </span><span class="si">%s</span><span class="s1">: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="n">proj_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">proj_id</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">proj_id</span><span class="p">]]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">proj_id</span><span class="p">}</span>

        <span class="n">projects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_caller</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;projects/&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">:</span>
            <span class="c1"># expand the only_allow_tools node</span>
            <span class="k">if</span> <span class="s2">&quot;only_allow_tools&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;only_allow_tools&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;only_allow_tools&quot;</span><span class="p">]</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">return</span> <span class="n">projects</span></div>

<div class="viewcode-block" id="NemoConnector.get_reservations"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_reservations">[docs]</a>    <span class="k">def</span> <span class="nf">get_reservations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dt_from</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dt_to</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cancelled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get reservations from the NEMO API filtered in various ways.</span>

<span class="sd">        Return a list of reservations from the API, filtered by date</span>
<span class="sd">        (inclusive). If only one argument is provided, the API will return all</span>
<span class="sd">        reservations either before or after the parameter. With no arguments,</span>
<span class="sd">        the method will return all reservations. The method will</span>
<span class="sd">        &quot;auto-expand&quot; linked information such as user, project, tool, etc. so</span>
<span class="sd">        results will have a full dictionary for each of those fields, rather</span>
<span class="sd">        than just the index (as returned from the API).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt_from</span>
<span class="sd">            The &quot;starting point&quot; of the time range; only reservations at or</span>
<span class="sd">            after this point in time will be returned</span>
<span class="sd">        dt_to</span>
<span class="sd">            The &quot;ending point&quot; of the time range; only reservations at</span>
<span class="sd">            or prior to this point in time will be returned</span>
<span class="sd">        tool_id</span>
<span class="sd">            A tool identifier (or list of them) to limit the scope of the</span>
<span class="sd">            reservation search (this should be the NEMO internal integer ID)</span>
<span class="sd">        cancelled</span>
<span class="sd">            Whether to get canceled or active reservations in the response</span>
<span class="sd">            (default is False -- meaning non-cancelled active reservations</span>
<span class="sd">            are returned by default). Set to None to include all reservations</span>
<span class="sd">            regardless of whether they are cancelled or active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        reservations : List[Dict]</span>
<span class="sd">            A list (could be empty) of reservations that match the date range</span>
<span class="sd">            supplied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dt_from</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start__gte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_from</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt_to</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;end__lte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_to</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cancelled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;cancelled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancelled</span>

        <span class="k">if</span> <span class="n">tool_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tool_id__in&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">])})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tool_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool_id</span><span class="p">)})</span>

        <span class="n">reservations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_caller</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;reservations/&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">parsed_reservations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reservation</span> <span class="ow">in</span> <span class="n">reservations</span><span class="p">:</span>
            <span class="n">parsed_reservations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_reservation</span><span class="p">(</span><span class="n">reservation</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">parsed_reservations</span></div>

    <span class="k">def</span> <span class="nf">_parse_reservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reservation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># expand various fields within the reservation data</span>
        <span class="k">if</span> <span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">reservation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">reservation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tool</span><span class="p">:</span>
                <span class="n">reservation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projects</span><span class="p">(</span><span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">reservation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;cancelled_by&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">reservation</span><span class="p">[</span><span class="s2">&quot;cancelled_by&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">reservation</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;cancelled_by&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">reservation</span>

<div class="viewcode-block" id="NemoConnector.get_usage_events"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_usage_events">[docs]</a>    <span class="k">def</span> <span class="nf">get_usage_events</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">event_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dt_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get usage events from the NEMO API filtered in various ways.</span>

<span class="sd">        Return a list of usage events from the API, filtered by date</span>
<span class="sd">        (inclusive). If only one argument is provided, the API will return all</span>
<span class="sd">        reservations either before or after the parameter. With no arguments,</span>
<span class="sd">        the method will return all reservations. The method will</span>
<span class="sd">        &quot;auto-expand&quot; linked information such as user, project, tool, etc. so</span>
<span class="sd">        results will have a full dictionary for each of those fields, rather</span>
<span class="sd">        than just the index (as returned from the API).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event_id</span>
<span class="sd">            The NEMO integer identifier (or a list of them) to fetch. If</span>
<span class="sd">            ``None``, the returned usage events will not be filtered by ID</span>
<span class="sd">            number</span>
<span class="sd">        user</span>
<span class="sd">            The user for which to fetch usage events, as either an integer</span>
<span class="sd">            representing their id in the NEMO instance, or as a string</span>
<span class="sd">            containing their username.  If ``None`` is given, usage events</span>
<span class="sd">            from all users will be returned.</span>
<span class="sd">        dt_range</span>
<span class="sd">            The &quot;starting&quot; and &quot;end&quot; points of the time range; only usage events</span>
<span class="sd">            starting between these points in time will be returned</span>
<span class="sd">        tool_id</span>
<span class="sd">            A tool identifier (or list of them) to limit the scope of the</span>
<span class="sd">            usage event search (this should be the NEMO internal integer ID).</span>
<span class="sd">            Regardless of what value is given, this method will always limit</span>
<span class="sd">            the API query to tools specified in the NexusLIMS DB for this</span>
<span class="sd">            harvester</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        usage_events : List</span>
<span class="sd">            A list (could be empty) of usage events that match the filters</span>
<span class="sd">            supplied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_dt_range</span><span class="p">(</span><span class="n">dt_range</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">event_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">event_id</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id__in&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">event_id</span><span class="p">])})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event_id</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users_by_username</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u_id</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_id</span>

        <span class="c1"># filtering for tool; if at the end of this block tool_id is an empty</span>
        <span class="c1"># list, we should just immediately return an empty list, since either</span>
        <span class="c1"># there were no tools for this connector in our DB, or the tools</span>
        <span class="c1"># specified were not found in the DB, so we know there are no</span>
        <span class="c1"># usage_events of interest</span>
        <span class="n">this_connectors_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_known_tool_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tool_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># by default (no tool_id specified), we should fetch events from</span>
            <span class="c1"># only the tools known to the NexusLIMS DB for this connector</span>
            <span class="n">tool_id</span> <span class="o">=</span> <span class="n">this_connectors_tools</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># coerce tool_id to list to make subsequent processing easier</span>
            <span class="n">tool_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool_id</span><span class="p">]</span>

        <span class="c1"># limit tool_id to values that are present in this_connectors_tools</span>
        <span class="n">tool_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tool_id</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">this_connectors_tools</span><span class="p">]</span>

        <span class="c1"># if tool_id is empty, we should just return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tool_id__in&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tool_id</span><span class="p">])})</span>

        <span class="n">usage_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_caller</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;usage_events/&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">parsed_events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">usage_events</span><span class="p">:</span>
            <span class="n">parsed_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">parsed_events</span></div>

    <span class="k">def</span> <span class="nf">_parse_dt_range</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dt_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]]],</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt_from</span><span class="p">,</span> <span class="n">dt_to</span> <span class="o">=</span> <span class="n">dt_range</span>
            <span class="k">if</span> <span class="n">dt_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start__gte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_from</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dt_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;end__lte&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_to</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_parse_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># expand various fields within the usage event data</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;operator&quot;</span><span class="p">]:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;operator&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_projects</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">proj</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tool</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">event</span>

<div class="viewcode-block" id="NemoConnector.write_usage_event_to_session_log"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.write_usage_event_to_session_log">[docs]</a>    <span class="k">def</span> <span class="nf">write_usage_event_to_session_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a usage event to the NexusLIMS database session log.</span>

<span class="sd">        Inserts two rows (if needed) into the ``session_log`` (marking the start</span>
<span class="sd">        and end of a usage event), only for instruments recognized by</span>
<span class="sd">        NexusLIMS (i.e. that have a row in the ``instruments`` table of the DB).</span>
<span class="sd">        If the usage event has not ended yet, no action is performed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event_id</span>
<span class="sd">            The NEMO id number for the event to insert</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_usage_events</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
            <span class="c1"># get_usage_events returns list, so pick out first one</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tool_api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">tools/?id=</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="n">get_instr_from_api_url</span><span class="p">(</span><span class="n">tool_api_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># this shouldn&#39;t happen since we limit our usage event API call</span>
                <span class="c1"># only to instruments contained in our DB, but we can still</span>
                <span class="c1"># defend against it regardless</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Usage event </span><span class="si">%s</span><span class="s2"> was for an instrument (</span><span class="si">%s</span><span class="s2">) not known &quot;</span>
                    <span class="s2">&quot;to NexusLIMS, so no records will be added to DB.&quot;</span><span class="p">,</span>
                    <span class="n">event_id</span><span class="p">,</span>
                    <span class="n">tool_api_url</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Usage event </span><span class="si">%s</span><span class="s2"> has not yet ended, so no records &quot;</span>
                    <span class="s2">&quot;will be added to DB.&quot;</span><span class="p">,</span>
                    <span class="n">event_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">usage_events/?id=</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># try to insert start log</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db_query</span><span class="p">(</span>
                <span class="s2">&quot;SELECT * FROM session_log WHERE session_identifier &quot;</span>
                <span class="s2">&quot;= ? AND event_type = ?&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># there was already a start log, so warn and don&#39;t do anything:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;A &#39;START&#39; log with session id </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> was found in the the DB, &quot;</span>
                    <span class="s2">&quot;so a new one will not be inserted for this event&quot;</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_log</span> <span class="o">=</span> <span class="n">SessionLog</span><span class="p">(</span>
                    <span class="n">session_identifier</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                    <span class="n">instrument</span><span class="o">=</span><span class="n">instr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="c1"># make sure to coerce format to ISO before putting in DB</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;START&quot;</span><span class="p">,</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                    <span class="n">record_status</span><span class="o">=</span><span class="s2">&quot;TO_BE_BUILT&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">start_log</span><span class="o">.</span><span class="n">insert_log</span><span class="p">()</span>

            <span class="c1"># try to insert end log</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">db_query</span><span class="p">(</span>
                <span class="s2">&quot;SELECT * FROM session_log WHERE session_identifier &quot;</span>
                <span class="s2">&quot;= ? AND event_type = ?&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># there was already an end log, so warn and don&#39;t do anything:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;An &#39;END&#39; log with session id </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> was found in the the DB, &quot;</span>
                    <span class="s2">&quot;so a new one will not be inserted for this event&quot;</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_log</span> <span class="o">=</span> <span class="n">SessionLog</span><span class="p">(</span>
                    <span class="n">session_identifier</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                    <span class="n">instrument</span><span class="o">=</span><span class="n">instr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="c1"># make sure to coerce format to ISO before putting in DB</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="n">event_type</span><span class="o">=</span><span class="s2">&quot;END&quot;</span><span class="p">,</span>
                    <span class="n">user</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                    <span class="n">record_status</span><span class="o">=</span><span class="s2">&quot;TO_BE_BUILT&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">end_log</span><span class="o">.</span><span class="n">insert_log</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No usage event with id = </span><span class="si">%s</span><span class="s2"> was found for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">event_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="NemoConnector.get_session_from_usage_event"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_session_from_usage_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_session_from_usage_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a Session representation of a usage event.</span>

<span class="sd">        Get a :py:class:`~nexusLIMS.db.session_handler.Session`</span>
<span class="sd">        representation of a usage event for use in dry runs of the record</span>
<span class="sd">        builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event_id</span>
<span class="sd">            The NEMO id number for the event to insert</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        session : ~nexusLIMS.db.session_handler.Session</span>
<span class="sd">            A representation of the usage_event from NEMO as a</span>
<span class="sd">            :py:class:`~nexusLIMS.db.session_handler.Session` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_usage_events</span><span class="p">(</span><span class="n">event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># we cannot reliably test an unended event, so exlcude from coverage</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Usage event with id = </span><span class="si">%s</span><span class="s2"> has not yet ended for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">event_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="n">get_instr_from_api_url</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">tools/?id=</span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">usage_events/?id=</span><span class="si">{</span><span class="n">event_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span>
                <span class="n">session_identifier</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instr</span><span class="p">,</span>
                <span class="n">dt_range</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">])),</span>
                <span class="n">user</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">session</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No usage event with id = </span><span class="si">%s</span><span class="s2"> was found for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="NemoConnector.get_known_tool_ids"><a class="viewcode-back" href="../../../../api/nexusLIMS.harvesters.nemo.html#nexusLIMS.harvesters.nemo.connector.NemoConnector.get_known_tool_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_known_tool_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get NEMO tool ID values from the NexusLIMS database.</span>

<span class="sd">        Inspect the ``api_url`` values of known Instruments (from</span>
<span class="sd">        the ``instruments`` table in the DB), and extract their tool_id number</span>
<span class="sd">        if it is from this NemoConnector.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tool_ids : List[int]</span>
<span class="sd">            The list of tool ID numbers known to NexusLIMS for this harvester</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tool_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">instrument_db</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">api_url</span><span class="p">:</span>
                <span class="c1"># Instrument is associated with this connector</span>
                <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">api_url</span><span class="p">)</span>
                <span class="c1"># extract &#39;id&#39; query parameter from url</span>
                <span class="n">tool_id</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span><span class="p">)[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tool_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tool_id</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tool_ids</span></div>

    <span class="k">def</span> <span class="nf">_get_users_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the users API with certain parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params</span>
<span class="sd">            A dictionary of query parameters for the API query</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        users</span>
<span class="sd">            A list (could be empty) of users that match the ids and/or</span>
<span class="sd">            usernames given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api_caller</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;users/&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="c1"># cache the users response by ID and username</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">users_by_username</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">user</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">_api_caller</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">verb</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a call to the NEMO API.</span>

<span class="sd">        Helper function to deduplicate actual calls to the API. Takes care of</span>
<span class="sd">        building the full URL from the base URL and specific endpoint,</span>
<span class="sd">        as well as authentication, passing of parameters, and parsing the</span>
<span class="sd">        results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        verb</span>
<span class="sd">            The ``requests`` verb (``&#39;POST&#39;``, ``&#39;GET&#39;``,</span>
<span class="sd">            ``&#39;PATCH&#39;``, etc.) to use for the API request</span>
<span class="sd">        endpoint</span>
<span class="sd">            The API endpoint to use. Should be formatted with a trailing</span>
<span class="sd">            slash and no leading slash. i.e. the endpoint for Projects data</span>
<span class="sd">            should be supplied as ``&#39;projects/&#39;``</span>
<span class="sd">        params</span>
<span class="sd">            The URL parameters to pass along with the request. These are</span>
<span class="sd">            generally filters for the API data such as ``id`` or a date range</span>
<span class="sd">            or something similar.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results</span>
<span class="sd">            The API response, formatted as a list of dict objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">],</span> <span class="n">endpoint</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;getting data from </span><span class="si">%s</span><span class="s2"> with parameters </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">nexus_req</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="n">token_auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>
</pre></div>

    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2023, NIST Office of Data and Informatics.<br/>
      Last updated on Sep, 19, 2023.<br/>
    </p>
  </div>
</footer>

  </body>
</html>